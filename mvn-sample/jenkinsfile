node {
    
    stage('Validation') {
        sh 'echo "Hello World!"'
    }

    def server = Artifactory.server "Jfrog-1"
    def buildInfo = Artifactory.newBuildInfo()

    // Project Path
    def project_path = "mvn-sample/"
    stage('Git Checkout to Main') {
        git branch: 'jenkins', url: 'https://github.com/MrRancy/devops-301.git'
    }
    dir('mvn-sample/') {
        stage('Maven Clean') {
            sh 'mvn clean'
        }
        stage('Maven Compile') {
            sh 'mvn compile'
        }
        stage('Maven Test') {
            sh 'mvn test'
        }
        stage('Maven Package') {
            sh 'mvn package'  
        }
	stage('Build Management') {
		def uploadSpec = """{ 
			"files": [
			{
			"pattern": "**/*.war",
			"target": "petclinic-repo"
			}
			]
		}"""
		server.upload spec: uploadSpec
	}
	stage('Publish Build Info'){
		server.download spec: downloadSpec, buildInfo: buildInfo
		server.upload spec: uploadSpec, buildInfo: buildInfo
		server.publishBuildInfo buildInfo
	}
	stage('Archive Artifact') {
		archiveArtifacts artifacts: 'target/petclinic.war', followSymlinks: false
	}
	stage('Docker Deployment') {
		sh 'docker-compose up -d'
	}
   }
}
